//CHECKSUM:5d5ea5f3b50378951135490d78afeea77f05355864ec6724cc4f018eaddc62a8
{"version":3,"sources":["../actions/choice_parse_answer.js"],"names":["_","require","INTENT_PREFIX","validateChoice","data","choice","undefined","config","bp","getModuleConfigForBot","event","botId","nb","get","preview","match","matchNumbers","index","parseInt","element","cms","getContentElement","contentId","matchNLU","findKey","keywords","intents","filter","x","toLowerCase","startsWith","map","substr","length","some","k","nlu","intent","name","includes","payload","temp","args"],"mappings":"AAAA;;AACA,MAAMA,CAAC,GAAGC,OAAO,CAAC,QAAD,CAAjB;;AACA,MAAMC,aAAa,GAAG,SAAtB;AAEA;;;;;;;;;AAQA,MAAMC,cAAc,GAAG,MAAMC,IAAN,IAAc;AACnC,MAAIC,MAAM,GAAGC,SAAb;AACA,QAAMC,MAAM,GAAG,MAAMC,EAAE,CAACD,MAAH,CAAUE,qBAAV,CAAgC,cAAhC,EAAgDC,KAAK,CAACC,KAAtD,CAArB;;AACA,QAAMC,EAAE,GAAGZ,CAAC,CAACa,GAAF,CAAMH,KAAK,CAACI,OAAN,CAAcC,KAAd,CAAoB,6BAApB,CAAN,EAA0D,KAA1D,CAAX;;AAEA,MAAIR,MAAM,CAACS,YAAP,IAAuBJ,EAA3B,EAA+B;AAC7B,UAAMK,KAAK,GAAGC,QAAQ,CAACN,EAAD,CAAR,GAAe,CAA7B;AACA,UAAMO,OAAO,GAAG,MAAMX,EAAE,CAACY,GAAH,CAAOC,iBAAP,CAAyBX,KAAK,CAACC,KAA/B,EAAsCP,IAAI,CAACkB,SAA3C,CAAtB;AACAjB,IAAAA,MAAM,GAAGL,CAAC,CAACa,GAAF,CAAMM,OAAN,EAAgB,oBAAmBF,KAAM,QAAzC,CAAT;AACD;;AAED,MAAI,CAACZ,MAAD,IAAWE,MAAM,CAACgB,QAAtB,EAAgC;AAC9BlB,IAAAA,MAAM,GAAGL,CAAC,CAACwB,OAAF,CAAUpB,IAAI,CAACqB,QAAf,EAAyBA,QAAQ,IAAI;AAC5C,YAAMC,OAAO,GAAGD,QAAQ,CACrBE,MADa,CACNC,CAAC,IAAI,CAACA,CAAC,IAAI,EAAN,EAAUC,WAAV,GAAwBC,UAAxB,CAAmC5B,aAAnC,CADC,EAEb6B,GAFa,CAETH,CAAC,IAAIA,CAAC,CAACI,MAAF,CAAS9B,aAAa,CAAC+B,MAAvB,CAFI,CAAhB;AAGA,aAAOjC,CAAC,CAACkC,IAAF,CAAOR,OAAP,EAAgBS,CAAC,IAAIzB,KAAK,CAAC0B,GAAN,CAAUC,MAAV,CAAiBC,IAAjB,KAA0BH,CAA/C,CAAP;AACD,KALQ,CAAT;AAMD;;AAED,MAAI,CAAC9B,MAAL,EAAa;AACXA,IAAAA,MAAM,GAAGL,CAAC,CAACwB,OAAF,CAAUpB,IAAI,CAACqB,QAAf,EAAyBA,QAAQ,IACxCzB,CAAC,CAACkC,IAAF,CACET,QAAQ,IAAI,EADd,EAEEU,CAAC,IACCnC,CAAC,CAACuC,QAAF,CAAW,CAAC7B,KAAK,CAACI,OAAN,IAAiB,EAAlB,EAAsBe,WAAtB,EAAX,EAAgD,CAACM,CAAC,IAAI,EAAN,EAAUN,WAAV,EAAhD,KACCnB,KAAK,CAAC8B,OAAN,IAAiBxC,CAAC,CAACuC,QAAF,CAAWvC,CAAC,CAACa,GAAF,CAAMH,KAAN,EAAa,cAAb,EAA6B,EAA7B,EAAiCmB,WAAjC,EAAX,EAA2D,CAACM,CAAC,IAAI,EAAN,EAAUN,WAAV,EAA3D,CAJtB,CADO,CAAT;AAQD;;AAED,MAAIxB,MAAJ,EAAY;AACVoC,IAAAA,IAAI,CAAC,oBAAD,CAAJ,GAA6B,IAA7B;AACAA,IAAAA,IAAI,CAAC,kBAAD,CAAJ,GAA2BpC,MAA3B;AACD,GAHD,MAGO;AACLoC,IAAAA,IAAI,CAAC,oBAAD,CAAJ,GAA6B,KAA7B;AACD;AACF,CArCD;;AAuCA,OAAOtC,cAAc,CAACuC,IAAD,CAArB","sourceRoot":"/var/lib/jenkins/workspace/build-linux/modules/basic-skills/src/backend","sourcesContent":["'use strict'\nconst _ = require('lodash')\nconst INTENT_PREFIX = 'intent:'\n\n/**\n * Get a variable under this user's storage\n * @title Validate user choice\n * @category Skills\n * @hidden true\n * @author Botpress, Inc.\n * @param {string} data - The parameters of the available choices\n */\nconst validateChoice = async data => {\n  let choice = undefined\n  const config = await bp.config.getModuleConfigForBot('basic-skills', event.botId)\n  const nb = _.get(event.preview.match(/^[#).!]?([\\d]{1,2})[#).!]?$/), '[1]')\n\n  if (config.matchNumbers && nb) {\n    const index = parseInt(nb) - 1\n    const element = await bp.cms.getContentElement(event.botId, data.contentId)\n    choice = _.get(element, `formData.choices.${index}.value`)\n  }\n\n  if (!choice && config.matchNLU) {\n    choice = _.findKey(data.keywords, keywords => {\n      const intents = keywords\n        .filter(x => (x || '').toLowerCase().startsWith(INTENT_PREFIX))\n        .map(x => x.substr(INTENT_PREFIX.length))\n      return _.some(intents, k => event.nlu.intent.name === k)\n    })\n  }\n\n  if (!choice) {\n    choice = _.findKey(data.keywords, keywords =>\n      _.some(\n        keywords || [],\n        k =>\n          _.includes((event.preview || '').toLowerCase(), (k || '').toLowerCase()) ||\n          (event.payload && _.includes(_.get(event, 'payload.text', '').toLowerCase(), (k || '').toLowerCase()))\n      )\n    )\n  }\n\n  if (choice) {\n    temp['skill-choice-valid'] = true\n    temp['skill-choice-ret'] = choice\n  } else {\n    temp['skill-choice-valid'] = false\n  }\n}\n\nreturn validateChoice(args)\n"]}